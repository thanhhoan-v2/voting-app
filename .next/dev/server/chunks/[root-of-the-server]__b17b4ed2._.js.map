{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/adrian-phan.team-mint.io/personal-projects/voting-app/src/lib/db.ts"],"sourcesContent":["import { neon } from '@neondatabase/serverless';\n\nif (!process.env.DATABASE_URL) {\n  throw new Error('DATABASE_URL is not set');\n}\n\nexport const sql = neon(process.env.DATABASE_URL);"],"names":[],"mappings":";;;;AAAA;;AAEA,IAAI,CAAC,QAAQ,GAAG,CAAC,YAAY,EAAE;IAC7B,MAAM,IAAI,MAAM;AAClB;AAEO,MAAM,MAAM,IAAA,gKAAI,EAAC,QAAQ,GAAG,CAAC,YAAY"}},
    {"offset": {"line": 60, "column": 0}, "map": {"version":3,"sources":["file:///Users/adrian-phan.team-mint.io/personal-projects/voting-app/src/lib/db-actions.ts"],"sourcesContent":["import { sql } from '@/lib/db';\n\nexport async function createTables() {\n  try {\n    // 기존 테이블 (레거시 지원)\n    await sql`\n      CREATE TABLE IF NOT EXISTS users (\n        id SERIAL PRIMARY KEY,\n        username VARCHAR(50) UNIQUE NOT NULL,\n        email VARCHAR(100) UNIQUE NOT NULL,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `;\n\n    // 폴 테이블 - created_by_name 추가\n    await sql`\n      CREATE TABLE IF NOT EXISTS polls (\n        id SERIAL PRIMARY KEY,\n        title VARCHAR(200) NOT NULL,\n        description TEXT,\n        created_by INTEGER REFERENCES users(id),\n        created_by_name VARCHAR(100),\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        ends_at TIMESTAMP\n      )\n    `;\n\n    // 폴 옵션 테이블 - 이미지 URL 추가\n    await sql`\n      CREATE TABLE IF NOT EXISTS poll_options (\n        id SERIAL PRIMARY KEY,\n        poll_id INTEGER REFERENCES polls(id) ON DELETE CASCADE,\n        option_text VARCHAR(200) NOT NULL,\n        image_url TEXT,\n        added_by_name VARCHAR(100),\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `;\n\n    // 투표 테이블 - display_name으로 변경\n    await sql`\n      CREATE TABLE IF NOT EXISTS votes (\n        id SERIAL PRIMARY KEY,\n        poll_id INTEGER REFERENCES polls(id) ON DELETE CASCADE,\n        option_id INTEGER REFERENCES poll_options(id) ON DELETE CASCADE,\n        user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,\n        display_name VARCHAR(100),\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        UNIQUE(poll_id, display_name)\n      )\n    `;\n\n    // 댓글 테이블 추가\n    await sql`\n      CREATE TABLE IF NOT EXISTS comments (\n        id SERIAL PRIMARY KEY,\n        poll_id INTEGER REFERENCES polls(id) ON DELETE CASCADE,\n        display_name VARCHAR(100) NOT NULL,\n        content TEXT,\n        image_url TEXT,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `;\n\n    // 컬럼 추가 (기존 테이블에 누락된 컬럼 추가)\n    await sql`\n      ALTER TABLE polls ADD COLUMN IF NOT EXISTS created_by_name VARCHAR(100)\n    `;\n\n    await sql`\n      ALTER TABLE poll_options ADD COLUMN IF NOT EXISTS image_url TEXT\n    `;\n\n    await sql`\n      ALTER TABLE poll_options ADD COLUMN IF NOT EXISTS added_by_name VARCHAR(100)\n    `;\n\n    await sql`\n      ALTER TABLE votes ADD COLUMN IF NOT EXISTS display_name VARCHAR(100)\n    `;\n\n    // display_name에 대한 unique index 생성 (constraint 대신 index 사용)\n    // 기존 user_id 기반 constraint 삭제\n    try {\n      await sql`ALTER TABLE votes DROP CONSTRAINT IF EXISTS votes_poll_id_user_id_key`;\n    } catch {\n      // 무시 - constraint가 없을 수 있음\n    }\n\n    // display_name 기반 unique index 추가\n    try {\n      await sql`CREATE UNIQUE INDEX IF NOT EXISTS idx_votes_poll_display_name ON votes (poll_id, display_name)`;\n    } catch {\n      // 무시 - index가 이미 있을 수 있음\n    }\n\n    // 기본 사용자 삽입\n    await sql`\n      INSERT INTO users (id, username, email)\n      VALUES (1, 'default_user', 'default@example.com')\n      ON CONFLICT (id) DO NOTHING\n    `;\n\n    console.log('Tables created successfully');\n  } catch (error) {\n    console.error('Error creating tables:', error);\n    throw error;\n  }\n}\n\nexport async function getUsers() {\n  try {\n    return await sql`SELECT * FROM users ORDER BY created_at DESC`;\n  } catch (error) {\n    console.error('Error getting users:', error);\n    throw error;\n  }\n}\n\n// 옵션 타입 정의\ninterface PollOptionInput {\n  text: string;\n  imageUrl?: string;\n}\n\nexport async function createPoll(\n  title: string,\n  description: string,\n  options: (string | PollOptionInput)[],\n  createdByName: string\n) {\n  try {\n    const [poll] = await sql`\n      INSERT INTO polls (title, description, created_by, created_by_name)\n      VALUES (${title}, ${description}, 1, ${createdByName})\n      RETURNING *\n    `;\n\n    console.log('Poll created:', poll);\n\n    for (const option of options) {\n      const optionText = typeof option === 'string' ? option : option.text;\n      const imageUrl = typeof option === 'string' ? null : option.imageUrl || null;\n\n      const [createdOption] = await sql`\n        INSERT INTO poll_options (poll_id, option_text, image_url, added_by_name)\n        VALUES (${poll.id}, ${optionText}, ${imageUrl}, ${createdByName})\n        RETURNING *\n      `;\n      console.log('Option created:', createdOption);\n    }\n\n    return poll;\n  } catch (error) {\n    console.error('Error creating poll:', error);\n    throw error;\n  }\n}\n\nexport async function getPolls() {\n  try {\n    // 먼저 테이블 마이그레이션 실행\n    await createTables();\n\n    const polls = await sql`\n      SELECT p.*,\n             COALESCE(p.created_by_name, u.username) as created_by_username,\n             COUNT(v.id) as total_votes\n      FROM polls p\n      LEFT JOIN users u ON p.created_by = u.id\n      LEFT JOIN votes v ON p.id = v.poll_id\n      GROUP BY p.id, u.username\n      ORDER BY p.created_at DESC\n    `;\n    console.log('Polls fetched:', polls);\n    return polls;\n  } catch (error) {\n    console.error('Error getting polls:', error);\n    throw error;\n  }\n}\n\nexport async function getPollById(id: number) {\n  try {\n    const [poll] = await sql`\n      SELECT p.*,\n             COALESCE(p.created_by_name, u.username) as created_by_username\n      FROM polls p\n      LEFT JOIN users u ON p.created_by = u.id\n      WHERE p.id = ${id}\n    `;\n\n    if (!poll) {\n      console.log('Poll not found with id:', id);\n      return null;\n    }\n\n    const options = await sql`\n      SELECT po.*, COUNT(v.id) as vote_count\n      FROM poll_options po\n      LEFT JOIN votes v ON po.id = v.option_id\n      WHERE po.poll_id = ${id}\n      GROUP BY po.id\n      ORDER BY po.created_at\n    `;\n\n    console.log('Poll fetched:', poll, 'with options:', options);\n    return { ...poll, options };\n  } catch (error) {\n    console.error('Error getting poll by id:', error);\n    throw error;\n  }\n}\n\n// display_name 기반 투표\nexport async function vote(pollId: number, optionId: number, displayName: string) {\n  console.log('Vote attempt:', { pollId, optionId, displayName });\n\n  try {\n    // 먼저 기존 투표 확인\n    console.log('Checking existing vote...');\n    const existingVote = await sql`\n      SELECT id FROM votes\n      WHERE poll_id = ${pollId} AND display_name = ${displayName}\n    `;\n    console.log('Existing vote result:', existingVote);\n\n    if (existingVote.length > 0) {\n      // 기존 투표 업데이트\n      console.log('Updating existing vote...');\n      await sql`\n        UPDATE votes\n        SET option_id = ${optionId}\n        WHERE poll_id = ${pollId} AND display_name = ${displayName}\n      `;\n    } else {\n      // 새 투표 삽입\n      console.log('Inserting new vote...');\n      await sql`\n        INSERT INTO votes (poll_id, option_id, user_id, display_name)\n        VALUES (${pollId}, ${optionId}, 1, ${displayName})\n      `;\n    }\n\n    const [option] = await sql`\n      SELECT COUNT(*) as vote_count\n      FROM votes\n      WHERE option_id = ${optionId}\n    `;\n\n    console.log('Vote recorded for poll:', pollId, 'option:', optionId, 'by:', displayName);\n    return option.vote_count;\n  } catch (error) {\n    console.error('Error voting - full error:', error);\n    throw error;\n  }\n}\n\n// 사용자가 해당 폴에 투표했는지 확인\nexport async function hasUserVoted(pollId: number, displayName: string) {\n  try {\n    const result = await sql`\n      SELECT option_id FROM votes\n      WHERE poll_id = ${pollId} AND display_name = ${displayName}\n    `;\n    return result.length > 0 ? result[0].option_id : null;\n  } catch (error) {\n    console.error('Error checking vote status:', error);\n    throw error;\n  }\n}\n\n// 폴 옵션 추가\nexport async function addPollOption(pollId: number, optionText: string, imageUrl: string | null, addedByName: string) {\n  try {\n    const [option] = await sql`\n      INSERT INTO poll_options (poll_id, option_text, image_url, added_by_name)\n      VALUES (${pollId}, ${optionText}, ${imageUrl}, ${addedByName})\n      RETURNING *\n    `;\n    console.log('Option added:', option);\n    return option;\n  } catch (error) {\n    console.error('Error adding option:', error);\n    throw error;\n  }\n}\n\n// 댓글 가져오기\nexport async function getComments(pollId: number) {\n  try {\n    const comments = await sql`\n      SELECT * FROM comments\n      WHERE poll_id = ${pollId}\n      ORDER BY created_at DESC\n    `;\n    return comments;\n  } catch (error) {\n    console.error('Error getting comments:', error);\n    throw error;\n  }\n}\n\n// 댓글 추가\nexport async function addComment(pollId: number, displayName: string, content: string | null, imageUrl: string | null) {\n  try {\n    const [comment] = await sql`\n      INSERT INTO comments (poll_id, display_name, content, image_url)\n      VALUES (${pollId}, ${displayName}, ${content}, ${imageUrl})\n      RETURNING *\n    `;\n    console.log('Comment added:', comment);\n    return comment;\n  } catch (error) {\n    console.error('Error adding comment:', error);\n    throw error;\n  }\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 362, "column": 0}, "map": {"version":3,"sources":["file:///Users/adrian-phan.team-mint.io/personal-projects/voting-app/src/app/api/polls/%5Bid%5D/options/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { addPollOption } from '@/lib/db-actions';\n\n// 폴 옵션 추가\nexport async function POST(\n  request: NextRequest,\n  { params }: { params: Promise<{ id: string }> }\n) {\n  try {\n    const resolvedParams = await params;\n    const { optionText, imageUrl, displayName } = await request.json();\n\n    if (!optionText) {\n      return NextResponse.json(\n        { error: 'Option text is required' },\n        { status: 400 }\n      );\n    }\n\n    if (!displayName) {\n      return NextResponse.json(\n        { error: 'Display name is required' },\n        { status: 400 }\n      );\n    }\n\n    const option = await addPollOption(\n      parseInt(resolvedParams.id),\n      optionText,\n      imageUrl || null,\n      displayName\n    );\n    return NextResponse.json(option, { status: 201 });\n  } catch (error) {\n    console.error('Error adding option:', error);\n    return NextResponse.json({ error: 'Failed to add option' }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAGO,eAAe,KACpB,OAAoB,EACpB,EAAE,MAAM,EAAuC;IAE/C,IAAI;QACF,MAAM,iBAAiB,MAAM;QAC7B,MAAM,EAAE,UAAU,EAAE,QAAQ,EAAE,WAAW,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEhE,IAAI,CAAC,YAAY;YACf,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC,aAAa;YAChB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA2B,GACpC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,MAAM,IAAA,8IAAa,EAChC,SAAS,eAAe,EAAE,GAC1B,YACA,YAAY,MACZ;QAEF,OAAO,gJAAY,CAAC,IAAI,CAAC,QAAQ;YAAE,QAAQ;QAAI;IACjD,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,wBAAwB;QACtC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAuB,GAAG;YAAE,QAAQ;QAAI;IAC5E;AACF"}}]
}